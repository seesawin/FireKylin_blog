{
    "version": 3,
    "sources": [
        "../../../../src/admin/controller/api/file.js"
    ],
    "names": [],
    "mappings": "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",
    "file": "../../../../src/admin/controller/api/file.js",
    "sourcesContent": [
        "import Base from './base';\nimport fs from 'fs';\nimport path from 'path';\nimport moment from 'moment';\nimport request from 'request';\nimport xml2js from 'xml2js';\nimport toMarkdown from 'to-markdown';\nimport qiniu from 'qiniu';\nimport upyun from 'upyun';\n\nrequest.defaults({\n  strictSSL: false,\n  rejectUnauthorized: false\n});\n\nexport default class extends Base {\n  uploadConfig = {};\n\n  async __before() {\n    this.uploadConfig = await this.getUploadConfig();\n  }\n\n  async postAction() {\n    /** 处理远程抓取 **/\n    if( this.post('fileUrl') ) {\n      return this.getFileByUrl(this.post('fileUrl'));\n    }\n    /** 处理导入数据 **/\n    if( this.post('importor') === 'wordpress' ) {\n      return this.importFromWP();\n    }\n\n    let file = this.file('file');\n\n    // qiniu && upyun\n    const uploadConfig = this.uploadConfig;\n    if (uploadConfig.type === 'qiniu') {\n      return this.uploadByQiniu(file.path, uploadConfig);\n    } else if (uploadConfig.type === 'upyun') {\n      return this.uploadByUpyun(file.path, uploadConfig);\n    }\n\n    if( !file ) {\n      if( this.post('fileUrl') ) {\n        return this.getFileByUrl( this.post('fileUrl') );\n      }\n      return this.fail('FILE_UPLOAD_ERROR');\n    }\n\n    let contentType = file.headers['content-type']; //check content-type if you want;\n\n    let basename = this.post('name') ? this.post('name') + path.extname(file.path) : path.basename(file.path);\n    let destDir = moment(new Date).format('YYYYMM');\n    let destPath = path.join( think.UPLOAD_PATH, destDir );\n    if( !think.isDir(destPath) ) {\n      think.mkdir(destPath);\n    }\n\n    let result = await think.promisify(fs.rename, fs)(file.path, path.join(destPath, basename));\n    if( result ) {\n      this.fail('FILE_UPLOAD_MOVE_ERROR');\n    }\n    return this.success(path.join('/static/upload', destDir, basename));\n  }\n\n  // 获取上传设置\n  async getUploadConfig() {\n    const options = await this.model('options').getOptions();\n    return options.upload;\n  }\n\n  // 域名不带http/https自动补全http\n  getAbsOrigin(origin) {\n    const reg = /^https?:\\/\\/.+/;\n    if (!reg.test(origin)) {\n      return `http://${origin}`;\n    }\n    return origin;\n  }\n\n  // 七牛相关方法\n  async qiniuUpload(filename, config) {\n    qiniu.conf.ACCESS_KEY = config.accessKey;\n    qiniu.conf.SECRET_KEY = config.secretKey;\n    const prefix = config.prefix ? `${config.prefix}/` : '';\n    const dir = moment(new Date()).format(\"YYYYMMDD\");\n    const basename = path.basename(filename);\n    const savePath = `${prefix}${dir}/${basename}`;\n    const token = new qiniu.rs.PutPolicy(`${config.bucket}:${savePath}`).token();\n    const extra = new qiniu.io.PutExtra();\n    return new Promise((resolve, reject) => {\n      qiniu.io.putFile(token, savePath, filename, extra, (err, ret) => {\n        if (err) {\n          reject(err);\n        } else {\n          const origin = this.getAbsOrigin(config.origin);\n          const compeletePath = `${origin}/${ret.key}`;\n          resolve(compeletePath);\n        }\n      });\n    });\n  }\n\n  async uploadByQiniu(filename, config) {\n    const result = await this.qiniuUpload(filename, config).catch((err) => {\n      return this.fail(\"FILE_UPLOAD_ERROR\");\n    })\n    return this.success(result);\n  }\n\n\n  // 又拍云相关方法\n  async upyunUpload(filename, config) {\n    const upyunInstance = new upyun(\n      config.upyunBucket, config.operater, config.password, 'v0.api.upyun.com', { apiVersion: 'v2' }\n    );\n    const prefix = config.upyunPrefix ? `${config.upyunPrefix}/` : '';\n    const dir = moment(new Date()).format(\"YYYYMMDD\");\n    const basename = path.basename(filename);\n    const remotePath = `${prefix}${dir}/${basename}`;\n    return new Promise((resolve, reject) => {\n      upyunInstance.putFile(remotePath, filename, null, false, {\n        'save-key': '/{year}{mon}{day}/{filename}{.suffix}'\n      }, (err, res) => {\n        if (err) {\n          reject(err);\n        } else {\n          if (res.statusCode === 200) {\n            const origin = this.getAbsOrigin(config.upyunOrigin);\n            const compeletePath = `${origin}/${remotePath}`;\n            resolve(compeletePath);\n          } else {\n            reject(res);\n          }\n        }\n      });\n    });\n  }\n\n  async uploadByUpyun(filename, config) {\n    const result = await this.upyunUpload(filename, config).catch((err) => {\n      return this.fail(\"FILE_UPLOAD_ERROR\");\n    })\n    return this.success(result);\n  }\n\n  async getFileByUrl(url) {\n    let fn = think.promisify(request.get);\n    let result = await fn({\n      url,\n      headers: {\n        \"User-Agent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_2) Chrome/47.0.2526.111 Safari/537.36\"\n      },\n      strictSSL: false,\n      timeout: 1000,\n      encoding: 'binary'\n    }).catch(() =>{\n      return this.fail(\"UPLOAD_URL_ERROR\");\n    });\n\n    if(result.headers[\"content-type\"].indexOf('image') === -1) {\n      return this.fail(\"UPLOAD_TYPE_ERROR\");\n    };\n\n    let writeFile = think.promisify(fs.writeFile, fs);\n    let destDir = moment(new Date).format('YYYYMM');\n    let basename = (this.post('name') ? this.post('name') : think.md5(result.body)) + path.extname(url);\n    let destPath = path.join( think.UPLOAD_PATH, destDir );\n    if( !think.isDir(destPath) ) {\n      think.mkdir(destPath);\n    }\n    result = await writeFile( path.join(destPath, basename), result.body, 'binary');\n    return this.success(path.join('/static/upload', destDir, basename));\n  }\n\n  async importFromWP() {\n    let file = this.file('file');\n    if( !file ) { return this.fail('FILE_UPLOAD_ERROR'); }\n\n    let readFile = think.promisify(fs.readFile, fs);\n    let parser = new xml2js.Parser();\n    let parseString = think.promisify(parser.parseString, parser);\n    let wxrXML = await readFile(file.path);\n    let wxrJSON = await parseString(wxrXML);\n    wxrJSON = this.formatArray(wxrJSON);\n    let channel = wxrJSON.rss.channel;\n    // 导入用户\n    if( channel.hasOwnProperty('wp:author') ) {\n      let authors = channel['wp:author'], userModelInstance = this.model('user');\n      let authorsPromise = authors.map(author => userModelInstance.addUser({\n        username: author['wp:author_login'][0],\n        email: author['wp:author_email'][0],\n        display_name: author['wp:author_display_name'][0],\n        password: 'admin12345678',\n        type: 2, //默认导入用户都为编辑\n        status: 2, //默认导入用户都处于禁用状态\n      }, '127.0.0.1'));\n      await Promise.all(authorsPromise);\n    }\n\n    //导入分类\n    //为了简单不支持子分类导入，默认所有分类为一级分类\n    let categories = channel['wp:category'], cateModelInstance = this.model('cate');\n    if( categories ) {\n      let categoriesPromise = categories.map(cate => cateModelInstance.addCate({\n        name: cate['wp:cat_name'][0],\n        pathname: decodeURIComponent(cate['wp:category_nicename'][0]),\n        pid: 0\n      }));\n      await Promise.all(categoriesPromise);\n    }\n\n    // 导入标签\n    let tags = channel['wp:tag'], tagModelInstance = this.model('tag');\n    if(tags) {\n      let tagsPromise = tags.map(tag => tagModelInstance.addTag({\n        name: tag['wp:tag_name'][0],\n        pathname: decodeURIComponent(tag['wp:tag_slug'][0])\n      }));\n      await Promise.all(tagsPromise);\n    }\n\n    //导入文章\n    let postStatus = {\n      publish: 3, //发布\n      future: 3,  //未来发布\n      draft: 0, //草稿\n      pending: 1, //待审核\n      private: 3, //私密文章对应 is_public 字段为 false, 发布状态为已发布\n      trash: 2, //删除文章没有对应关系遂转为已拒绝文章\n    };\n    let posts = channel.item.filter(item => item['wp:post_type'][0] ==='post');\n    let postModelInstance = this.model('post');\n    let postsPromise = posts.map(async item => {\n      try{\n      //获取用户\n      let user = await this.model('user').where({name: item['dc:creator'][0]}).find();\n      //查询分类 ID\n      let cate = [];\n      if( item.hasOwnProperty('category') ) {\n        let cates = item.category.filter(item => item.$.domain === 'category').map(item => item._);\n        if( Array.isArray(cates) && cates.length > 0 ) {\n          cate = await this.model('cate').setRelation(false).field('id').where({name: ['IN', cates]}).select();\n          cate = cate.map(item => item.id);\n        }\n      }\n      //摘要有可能是空\n      let summary;\n      if( item.hasOwnProperty('excerpt:encoded') && item['excerpt:encoded'][0] !== '' ) {\n        summary = item['excerpt:encoded'][0];\n      } else {\n        summary = item['content:encoded'][0];\n      }\n\n      let post = {\n        title: item.title[0],\n        pathname: decodeURIComponent(item['wp:post_name'][0]),\n        content: item['content:encoded'][0],\n        summary,\n        create_time: moment(new Date(item.pubDate[0])).format('YYYY-MM-DD HH:mm:ss'),\n        update_time: item['wp:post_date'][0],\n        status: postStatus[ item['wp:status'][0] ] || 0,\n        user_id: user.id,\n        comment_num: 0,\n        allow_comment: Number(item['wp:comment_status'][0] === 'open'),\n        is_public: Number(item['wp:status'][0] !== 'private'),\n        tag: item.hasOwnProperty('category') ? item.category.filter(item => item.$.domain === 'post_tag').map(item => item._) : [],\n        cate\n      };\n      post.markdown_content = toMarkdown(post.content);\n      await postModelInstance.addPost(post);\n      } catch(e) { console.log(e)}\n    });\n    Promise.all(postsPromise);\n\n    //导入页面\n    let pages = channel.item.filter(item => item['wp:post_type'][0] === 'page');\n    let pageModelInstance = this.model('page').setRelation('user');\n    let pagesPromise = pages.map(async item => {\n      let user = await this.model('user').where({name: item['dc:creator'][0]}).find();\n      let summary = item['excerpt:encoded'][0];\n      if( summary === '' ) {\n        summary = item['content:encoded'][0];\n      }\n\n      let page = {\n        title: item.title[0],\n        pathname: decodeURIComponent(item['wp:post_name'][0]),\n        content: item['content:encoded'][0],\n        summary,\n        create_time: moment(new Date(item.pubDate[0])).format('YYYY-MM-DD HH:mm:ss'),\n        update_time: item['wp:post_date'][0],\n        status: postStatus[ item['wp:status'][0] ] || 0,\n        user_id: user.id,\n        comment_num: 0,\n        allow_comment: item['wp:comment_status'][0] === 'open',\n        is_public: item['wp:status'][0] !== 'private',\n      };\n      page.markdown_content = toMarkdown(page.content);\n      await pageModelInstance.addPost(page);\n    });\n    Promise.all(pagesPromise);\n    this.success(`共导入文章 ${(posts || []).length} 篇，页面 ${(pages || []).length} 页，分类 ${(categories || []).length} 个，标签 ${(tags || []).length} 个`);\n  }\n\n  formatArray(obj) {\n    for(var i in obj) {\n      if( Array.isArray(obj[i]) && obj[i].length === 1 ) {\n        obj[i] = obj[i][0];\n      } else if( typeof(obj[i]) === 'object' ) {\n        obj[i] = this.formatArray(obj[i]);\n      }\n    }\n    return obj;\n  }\n}\n"
    ]
}